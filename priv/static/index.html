<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MerkleDb | High-Performance Vector Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        :root {
            --primary: #6366f1;
            --dark: #0f172a;
            --light: #f8fafc;
        }
        body { background-color: var(--light); font-family: 'Inter', sans-serif; color: var(--dark); }
        .hero { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; padding: 4rem 0; margin-bottom: 2rem; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .stat-card { text-align: center; padding: 1.5rem; }
        .stat-value { font-size: 2rem; font-weight: 800; color: var(--primary); }
        .search-box { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-top: -4rem; }
        #results { max-height: 600px; overflow-y: auto; }
        .verse-item { padding: 1rem; border-bottom: 1px solid #e2e8f0; transition: background 0.2s; }
        .verse-item:hover { background: #f1f5f9; }
        .progress { height: 10px; border-radius: 5px; }
        .badge-dist { background: var(--primary); font-size: 0.8rem; }
        .chart-container { min-height: 350px; }
    </style>
</head>
<body x-data="app()">
    <div class="hero">
        <div class="container text-center">
            <h1 class="display-4 fw-bold">MerkleDb Analytics</h1>
            <p class="lead">Researching the KJV Bible with AVX2-Accelerated Vector Intelligence</p>
        </div>
    </div>

    <div class="container mb-5">
        <div class="search-box">
            <div class="row g-3">
                <div class="col-md-8">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-white border-end-0"><i class="fa fa-search text-muted"></i></span>
                        <input type="text" class="form-control border-start-0" placeholder="Type a concept (e.g. 'creation of light', 'love and faith')..." 
                               x-model="query" @input.debounce.300ms="search()">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-lg w-100" @click="ingest()" :disabled="status.status === 'busy'">
                            <i class="fa fa-database me-2"></i>Ingest Corpus
                        </button>
                        <button class="btn btn-outline-secondary btn-lg" @click="toggleSettings = !toggleSettings">
                            <i class="fa fa-cog"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div x-show="toggleSettings" x-transition class="mt-3 p-3 bg-light rounded">
                <h6>Search Parameters</h6>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Threshold: <span x-text="threshold"></span></label>
                        <input type="range" class="form-range" min="0" max="1" step="0.05" x-model="threshold">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Limit: <span x-text="limit"></span></label>
                        <input type="number" class="form-control" x-model="limit">
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <template x-if="status.status === 'running'">
            <div class="mt-4 card p-3 border-primary">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-bold">Background Job in Progress...</span>
                    <span x-text="status.percent + '%'"></span>
                </div>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" :style="'width: ' + status.percent + '%'"></div>
                </div>
                <div class="mt-2 text-muted small">
                    Found <span x-text="status.found_count"></span> semantic clusters so far.
                </div>
            </div>
        </template>

        <!-- Stats Row -->
        <div class="row mt-4 g-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="text-muted small text-uppercase">Total Vectors</div>
                    <div class="stat-value" x-text="summary.count || 0"></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="text-muted small text-uppercase">Dimensions</div>
                    <div class="stat-value" x-text="summary.dim || 0"></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="text-muted small text-uppercase">Search Speed</div>
                    <div class="stat-value"><span x-text="lastSearchTime"></span> <small>ms</small></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="text-muted small text-uppercase">Engine Mode</div>
                    <div class="stat-value text-success" x-text="summary.indexed ? 'IVF+AVX2' : 'FLAT+AVX2'"></div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Search Results -->
            <div class="col-lg-7">
                <div class="card p-4">
                    <h5 class="mb-4"><i class="fa fa-list me-2 text-primary"></i>Semantic Search Results</h5>
                    <div id="results">
                        <template x-for="res in results" :key="res.id">
                            <div class="verse-item">
                                <div class="d-flex justify-content-between">
                                    <span class="fw-bold text-primary" x-text="res.id"></span>
                                    <span class="badge badge-dist" x-text="res.distance.toFixed(4)"></span>
                                </div>
                                <p class="mb-0 mt-2 text-dark" x-text="res.text"></p>
                            </div>
                        </template>
                        <template x-if="results.length === 0">
                            <div class="text-center py-5 text-muted">
                                <i class="fa fa-info-circle fa-2x mb-3"></i>
                                <p>No results yet. Try searching or ingesting data.</p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Analytics Dashboard -->
            <div class="col-lg-5">
                <div class="card p-4 mb-4">
                    <h5 class="mb-4"><i class="fa fa-chart-pie me-2 text-primary"></i>Cluster Distribution</h5>
                    <div id="clusterChart" class="chart-container"></div>
                </div>
                
                <div class="card p-4">
                    <h5 class="mb-4"><i class="fa fa-wave-square me-2 text-primary"></i>Vector Space Density</h5>
                    <div id="distChart" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                query: '',
                threshold: 0.35,
                limit: 10,
                results: [],
                status: { status: 'idle', percent: 0, found_count: 0 },
                summary: {},
                lastSearchTime: 0,
                toggleSettings: false,
                clusterChart: null,
                distChart: null,

                init() {
                    this.pollStatus();
                    this.fetchSummary();
                    this.initCharts();
                    setInterval(() => this.pollStatus(), 2000);
                    setInterval(() => this.fetchSummary(), 5000);
                },

                async ingest() {
                    await fetch('/ingest', { method: 'POST' });
                    alert('Ingestion started! Vectors are being generated using AVX2 kernels.');
                },

                async search() {
                    if (!this.query) { this.results = []; return; }
                    const start = performance.now();
                    const resp = await fetch(`/search?q=${encodeURIComponent(this.query)}&limit=${this.limit}&threshold=${this.threshold}`);
                    this.results = await resp.json();
                    this.lastSearchTime = (performance.now() - start).toFixed(1);
                    this.updateDistChart();
                },

                async pollStatus() {
                    const resp = await fetch('/job/status');
                    this.status = await resp.json();
                    if (this.status.topics.length > 0) {
                        this.updateClusterChart();
                    }
                },

                async fetchSummary() {
                    try {
                        const resp = await fetch('/analytics/summary');
                        if (resp.ok) this.summary = await resp.json();
                    } catch(e) {}
                },

                initCharts() {
                    const clusterOptions = {
                        series: [],
                        chart: { type: 'donut', height: 350 },
                        labels: [],
                        responsive: [{ breakpoint: 480, options: { chart: { width: 200 }, legend: { position: 'bottom' } } }]
                    };
                    this.clusterChart = new ApexCharts(document.querySelector("#clusterChart"), clusterOptions);
                    this.clusterChart.render();

                    const distOptions = {
                        series: [{ name: 'Similarity', data: [] }],
                        chart: { type: 'area', height: 350, animations: { enabled: false } },
                        dataLabels: { enabled: false },
                        stroke: { curve: 'smooth' },
                        xaxis: { categories: [] },
                        colors: ['#6366f1']
                    };
                    this.distChart = new ApexCharts(document.querySelector("#distChart"), distOptions);
                    this.distChart.render();
                },

                updateClusterChart() {
                    const labels = this.status.topics.map(t => t.label.substring(0, 20));
                    const counts = this.status.topics.map(t => t.count);
                    this.clusterChart.updateOptions({ labels: labels, series: counts });
                },

                updateDistChart() {
                    const data = this.results.map(r => r.distance);
                    const labels = this.results.map(r => r.id);
                    this.distChart.updateSeries([{ name: 'Similarity Score', data: data }]);
                    this.distChart.updateOptions({ xaxis: { categories: labels } });
                }
            }
        }
    </script>
</body>
</html>
