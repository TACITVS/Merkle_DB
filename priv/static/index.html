<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>MerkleDB Vector Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; }
        .hero { padding: 3rem 0; background: #1e293b; border-bottom: 1px solid #334155; position: relative; }
        .topic-card { background-color: #334155; border: 1px solid #475569; margin-bottom: 1rem; cursor: pointer; animation: fadeIn 0.5s; }
        .topic-card:hover { border-color: #3b82f6; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .control-deck { background: #0f172a; border: 1px solid #334155; border-radius: 50px; padding: 0.5rem 2rem; display: inline-flex; gap: 1rem; align-items: center; }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .top-actions { position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem; }
    </style>
</head>
<body>

    <div class="hero text-center">
        <div class="top-actions">
            <button id="tuneBtn" onclick="autoTune()" class="btn btn-outline-info btn-sm">
                ✨ Auto-Tune
            </button>
            <button id="ingestBtn" onclick="ingestCorpus()" class="btn btn-outline-success btn-sm">
                Initialize / Ingest Data
            </button>
        </div>

        <h1 class="display-5 fw-bold mb-3">Merkle<span class="text-primary">DB</span></h1>
        
        <div style="max-width: 600px; margin: 0 auto;">
            <input type="text" id="searchInput" class="form-control form-control-lg bg-dark text-white mb-3" 
                   placeholder="Search..." onkeyup="if(event.key==='Enter') performSearch()">
        </div>

        <div class="mt-4">
            <div class="control-deck">
                <button onclick="control('start')" class="btn btn-success btn-circle" title="Start Discovery"><i class="bi bi-play-fill"></i></button>
                <button onclick="control('pause')" class="btn btn-warning btn-circle" title="Pause"><i class="bi bi-pause-fill"></i></button>
                <button onclick="control('resume')" class="btn btn-info btn-circle" title="Resume"><i class="bi bi-skip-start-fill"></i></button>
                <button onclick="control('stop')" class="btn btn-danger btn-circle" title="Stop"><i class="bi bi-stop-fill"></i></button>
                <div style="width: 1px; height: 20px; background: #334155;"></div>
                <button onclick="control('save')" class="btn btn-outline-light btn-circle" title="Save State"><i class="bi bi-save"></i></button>
                <button onclick="control('load')" class="btn btn-outline-light btn-circle" title="Load State"><i class="bi bi-folder2-open"></i></button>
            </div>
            
            <div class="mt-3 text-muted">
                <span id="statusBadge" class="badge bg-secondary">IDLE</span>
                <span id="progressText" class="ms-2">Ready to Cluster</span>
            </div>
            
            <div class="progress mt-2 mx-auto" style="width: 300px; height: 6px; background: #334155;">
                <div id="progressBar" class="progress-bar bg-primary" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <div id="topicsGrid" class="row"></div>
        <hr>
        <div id="resultsArea" class="row"></div>
    </div>

    <script>
        let poller;

        async function control(action) {
            try {
                const res = await fetch(`/job/${action}`, { method: 'POST' });
                
                // ERROR HANDLING ADDED
                if (!res.ok) {
                    const msg = await res.text();
                    alert("⚠️ Error: " + msg);
                    return;
                }

                if(action === 'start' || action === 'resume' || action === 'load') {
                    if(!poller) poller = setInterval(updateStatus, 1000);
                }
            } catch(e) {
                console.error(e);
                alert("Server Error");
            }
        }

        async function updateStatus() {
            try {
                const res = await fetch('/job/status');
                const data = await res.json();
                
                document.getElementById('statusBadge').textContent = data.status.toUpperCase();
                document.getElementById('statusBadge').className = 
                    `badge ${data.status === 'running' ? 'bg-success' : 'bg-secondary'}`;
                
                document.getElementById('progressText').textContent = 
                    `${data.percent}% Scanned - ${data.found_count} Topics Found`;
                document.getElementById('progressBar').style.width = data.percent + "%";

                const grid = document.getElementById('topicsGrid');
                grid.innerHTML = data.topics.map(t => `
                    <div class="col-md-3">
                        <div class="topic-card p-3 rounded" onclick="performSearch('${t.label.substring(0,15)}')">
                            <div class="d-flex justify-content-between text-muted mb-1">
                                <small>TOPIC</small>
                                <span class="badge bg-dark">${t.count}</span>
                            </div>
                            <div class="text-light" style="font-size: 0.9rem; line-height: 1.2;">${t.label}</div>
                        </div>
                    </div>
                `).join('');

                if(data.status === 'done' || data.status === 'idle') clearInterval(poller);
            } catch(e) { console.error("Poll error", e); }
        }

        async function performSearch(val) {
            const q = val || document.getElementById('searchInput').value;
            const res = await fetch(`/search?q=${encodeURIComponent(q)}&threshold=0.30&limit=50`);
            const results = await res.json();
            document.getElementById('resultsArea').innerHTML = results.map(r => 
                `<div class="col-12 mb-2"><div class="p-3 border rounded border-secondary bg-dark">
                    <div class="d-flex justify-content-between text-primary mb-1">
                        <small>${r.verse}</small> <small>Sim: ${r.distance.toFixed(4)}</small>
                    </div>
                    ${r.text}
                </div></div>`
            ).join('');
        }

        async function ingestCorpus() {
            if(!confirm("Start ingestion? This will take about 30s.")) return;
            const btn = document.getElementById('ingestBtn');
            btn.textContent = "Ingesting...";
            btn.disabled = true;
            
            try {
                await fetch('/ingest', { method: 'POST' });
                alert("Ingestion started! Check terminal for progress dots.");
            } catch(e) {
                alert("Error starting ingestion.");
                btn.disabled = false;
                btn.textContent = "Initialize / Ingest Data";
            }
        }
        
        async function autoTune() {
            const btn = document.getElementById('tuneBtn');
            btn.textContent = "Tuning...";
            const res = await fetch('/tune', { method: 'POST' });
            const data = await res.json();
            alert(`Tuning Complete. Recommended Threshold: ${data.recommended}`);
            btn.textContent = "✨ Auto-Tune";
        }
    </script>
</body>
</html>